<%@ page session="true" import="com.gauce.*,com.gauce.io.*,com.gauce.common.*,com.gauce.log.*,com.gauce.db.*,java.sql.*"%><%@ 
include file="../../../comm_function/conn_q_pool.jsp"%><%
 // 다음 문장은 수정 하시요 (파라메터 갯수만큼 (없으면 //로 막으세요)--r
      String arg_yyyy = req.getParameter("arg_yyyy");
 //---------------------------------------------------------- 
     dSet.addDataColumn(new GauceDataColumn("tag_name",GauceDataColumn.TB_STRING,7));
	 dSet.addDataColumn(new GauceDataColumn("dept_code",GauceDataColumn.TB_STRING,7));
	 dSet.addDataColumn(new GauceDataColumn("dept_name",GauceDataColumn.TB_STRING,50));
	 dSet.addDataColumn(new GauceDataColumn("sort_tag",GauceDataColumn.TB_DECIMAL,1,0));
	 dSet.addDataColumn(new GauceDataColumn("sort_name",GauceDataColumn.TB_STRING,50));
     dSet.addDataColumn(new GauceDataColumn("CHANGE_SUM_AMT",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("pre_amt",GauceDataColumn.TB_DECIMAL,18,0));
     dSet.addDataColumn(new GauceDataColumn("this_01",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_02",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_03",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_04",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_05",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_06",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_07",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_08",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_09",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_10",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_11",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_12",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("this_sum",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("pre_this_sum",GauceDataColumn.TB_DECIMAL,18,0));
	 dSet.addDataColumn(new GauceDataColumn("rate_cont",GauceDataColumn.TB_DECIMAL,18,0));
	 
    String query = "  ";
query = query +  "        select ( select z.child_name from z_code_etc_child z where z.class_tag = '011' and z.etc_code = re.receive_tag) tag_name, ";
query = query +  "              re.dept_code,";
query = query +  "              re.const_name dept_name, ";
query = query +  " 		       1 sort_tag,";
query = query +  " 		       '계획' sort_name,";
query = query +  " 				 trunc(re.change_sum_amt,-6)/1000000 change_sum_amt,";
query = query +  "           sum(case when to_char(e.issue_date,'yyyy') < '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_amt,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'01', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_01,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'02', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_02,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'03', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_03,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'04', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_04,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'05', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_05,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'06', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_06,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'07', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_07,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'08', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_08,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'09', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_09,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'10', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_10,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'11', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_11,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'12', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_12,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyy'), '"+arg_yyyy+"', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_sum,";
query = query +  " 				 sum(case when to_char(e.issue_date,'yyyy') <= '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_this_sum,";
query = query +  " 				 null rate_cont	  ";
query = query +  " 	  from r_contract_time_extablished e,";
query = query +  " 		      r_contract_register re,";
query = query +  " 		      ( select r.dept_code,";
query = query +  " 				         r.cont_no,";
query = query +  " 				         max(r.chg_degree) chg_degree ";
query = query +  " 				    from r_contract_register r,";
query = query +  " 					      (select dept_code,";
query = query +  " 							        max(cont_no) cont_no";
query = query +  " 								from r_contract_register";
query = query +  " 							 group by dept_code) aa";
query = query +  " 					where aa.dept_code = r.dept_code";
query = query +  " 					  and aa.cont_no   = r.cont_no";
query = query +  " 				  group by r.dept_code, r.cont_no";
query = query +  " 				) mx ";
query = query +  " 	 where mx.dept_code = re.dept_code(+)";
query = query +  " 	   and mx.cont_no   = re.cont_no(+)";
query = query +  " 		and mx.chg_degree = re.chg_degree(+)";
query = query +  "      and mx.dept_code = e.dept_code";
query = query +  " 	group by re.receive_tag, re.dept_code ,re.const_name,re.change_sum_amt";
query = query +  " union all";
query = query +  "        select ( select z.child_name from z_code_etc_child z where z.class_tag = '011' and z.etc_code = re.receive_tag) tag_name, ";
query = query +  "            re.dept_code,";
query = query +  "         '' dept_name,"; 
query = query +  " 	       2 sort_tag,";
query = query +  " 		       '실적' sort_name,";
query = query +  " 				null change_sum_amt,";
query = query +  " 				 sum(case when to_char(e.received_date,'yyyy') < '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_amt,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'01', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_01,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'02', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_02,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'03', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_03,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'04', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_04,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'05', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_05,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'06', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_06,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'07', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_07,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'08', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_08,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'09', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_09,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'10', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_10,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'11', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_11,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'12', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_12,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyy'), '"+arg_yyyy+"', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_sum,";
query = query +  " 				 sum(case when to_char(e.received_date,'yyyy') <= '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_this_sum,";
query = query +  " 				null rate_cont";
query = query +  " 	  from r_contract_time_collection e,";
query = query +  " 		      r_contract_register re,";
query = query +  " 		      ( select r.dept_code,";
query = query +  " 				         r.cont_no,";
query = query +  " 				         max(r.chg_degree) chg_degree ";
query = query +  " 				    from r_contract_register r,";
query = query +  " 					      (select dept_code,";
query = query +  " 							        max(cont_no) cont_no";
query = query +  " 								from r_contract_register";
query = query +  " 							 group by dept_code) aa";
query = query +  " 					where aa.dept_code = r.dept_code";
query = query +  " 					  and aa.cont_no   = r.cont_no";
query = query +  " 				  group by r.dept_code, r.cont_no";
query = query +  " 				) mx ";
query = query +  " 	 where mx.dept_code = re.dept_code(+)";
query = query +  " 	   and mx.cont_no   = re.cont_no(+)";
query = query +  " 		  and mx.chg_degree = re.chg_degree(+)";
query = query +  "      and mx.dept_code = e.dept_code";
query = query +  " 	group by re.receive_tag, re.dept_code,re.change_sum_amt";
query = query +  " union all";
query = query +  "        select ( select z.child_name from z_code_etc_child z where z.class_tag = '011' and z.etc_code = re.receive_tag) tag_name, ";
query = query +  "            re.dept_code,";
query = query +  "         '' dept_name,";
query = query +  "        3 sort_tag, ";
query = query +  " 		       '실적율%' sort_name,";
query = query +  "        null CHANGE_SUM_AMT,";
query = query +  " 			 decode( plan.pre_amt, 0, 0, nvl(trunc(rec.pre_amt/ plan.pre_amt * 100, 2),0)) rate_pre,";
query = query +  " 			 decode( plan.this_01, 0, 0, nvl(trunc(rec.this_01/ plan.this_01 * 100, 2),0)) rate_01,";
query = query +  " 			 decode( plan.this_02, 0, 0, nvl(trunc(rec.this_02/ plan.this_02 * 100, 2),0)) rate_02,";
query = query +  " 			 decode( plan.this_03, 0, 0, nvl(trunc(rec.this_03/ plan.this_03 * 100, 2),0)) rate_03,";
query = query +  " 			 decode( plan.this_04, 0, 0, nvl(trunc(rec.this_04/ plan.this_04 * 100, 2),0)) rate_04,";
query = query +  " 			 decode( plan.this_05, 0, 0, nvl(trunc(rec.this_05/ plan.this_05 * 100, 2),0)) rate_05,";
query = query +  " 			 decode( plan.this_06, 0, 0, nvl(trunc(rec.this_06/ plan.this_06 * 100, 2),0)) rate_06,";
query = query +  " 			 decode( plan.this_07, 0, 0, nvl(trunc(rec.this_07/ plan.this_07 * 100, 2),0)) rate_07,";
query = query +  " 			 decode( plan.this_08, 0, 0, nvl(trunc(rec.this_08/ plan.this_08 * 100, 2),0)) rate_08,";
query = query +  " 			 decode( plan.this_09, 0, 0, nvl(trunc(rec.this_09/ plan.this_09 * 100, 2),0)) rate_09,";
query = query +  " 			 decode( plan.this_10, 0, 0, nvl(trunc(rec.this_10/ plan.this_10 * 100, 2),0)) rate_10,";
query = query +  " 			 decode( plan.this_11, 0, 0, nvl(trunc(rec.this_11/ plan.this_11 * 100, 2),0)) rate_11,";
query = query +  " 			 decode( plan.this_12, 0, 0, nvl(trunc(rec.this_12/ plan.this_12 * 100, 2),0)) rate_12,";
query = query +  " 			 decode( plan.this_sum, 0, 0, nvl(trunc(rec.this_sum/ plan.this_sum * 100, 2),0)) this_sum,";
query = query +  " 			 decode( plan.pre_this_sum, 0, 0, nvl(trunc(rec.pre_this_sum/ plan.pre_this_sum * 100, 2),0)) pre_this_sum,";
query = query +  " 			 decode( trunc(re.CHANGE_SUM_AMT, -6)/1000000, 0, 0, nvl(trunc(rec.pre_this_sum/ (trunc(re.CHANGE_SUM_AMT, -6)/1000000) * 100, 2),0)) rate_cont";
query = query +  "   from r_contract_register re,";
query = query +  " 	";
query = query +  " (  select r.dept_code,";
query = query +  "           r.cont_no,";
query = query +  "           max(r.chg_degree) chg_degree ";
query = query +  "      from r_contract_register r,";
query = query +  " 		       (select dept_code,";
query = query +  " 				         max(cont_no) cont_no";
query = query +  " 					 from r_contract_register";
query = query +  " 				  group by dept_code) aa";
query = query +  " 		 where aa.dept_code = r.dept_code";
query = query +  " 		   and aa.cont_no   = r.cont_no";
query = query +  " 		group by r.dept_code, r.cont_no";
query = query +  " ) mx,   ";
query = query +  " (  select e.dept_code,";
query = query +  " 				 sum(case when to_char(e.issue_date,'yyyy') < '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_amt,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'01', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_01,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'02', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_02,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'03', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_03,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'04', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_04,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'05', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_05,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'06', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_06,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'07', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_07,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'08', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_08,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'09', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_09,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'10', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_10,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'11', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_11,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyymm'), '"+arg_yyyy+"'||'12', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_12,";
query = query +  " 				 sum(decode(to_char(e.issue_date,'yyyy'), '"+arg_yyyy+"', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_sum,";
query = query +  " 				 sum(case when to_char(e.issue_date,'yyyy') <= '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_this_sum";
query = query +  " 				 ";
query = query +  " 	  from r_contract_time_extablished e";
query = query +  " 	 where to_char(e.issue_date, 'yyyy') <= '"+arg_yyyy+"'";
query = query +  " 	group by e.dept_code";
query = query +  " ) plan,";
query = query +  " (	select e.dept_code,";
query = query +  " 				 sum(case when to_char(e.received_date,'yyyy') < '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_amt,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'01', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_01,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'02', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_02,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'03', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_03,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'04', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_04,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'05', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_05,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'06', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_06,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'07', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_07,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'08', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_08,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'09', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_09,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'10', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_10,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'11', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_11,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyymm'), '"+arg_yyyy+"'||'12', nvl(trunc(sum_amt, -6)/1000000,0), 0)) this_12,";
query = query +  " 				 sum(decode(to_char(e.received_date,'yyyy'), '"+arg_yyyy+"', nvl(trunc(e.sum_amt, -6)/1000000,0), 0)) this_sum,";
query = query +  " 				 sum(case when to_char(e.received_date,'yyyy') <= '"+arg_yyyy+"'";
query = query +  " 				 			 then nvl(trunc(sum_amt, -6)/1000000,0)";
query = query +  " 							 else 0";
query = query +  " 					  end) pre_this_sum";
query = query +  " 				 ";
query = query +  " 	  from r_contract_time_collection e";
query = query +  " 	 where to_char(e.received_date, 'yyyy') <= '"+arg_yyyy+"'";
query = query +  " 	group by e.dept_code";
query = query +  " ) rec ";
query = query +  "  where mx.dept_code = re.dept_code";
query = query +  "    and mx.cont_no   = re.cont_no";
query = query +  " 		and mx.chg_degree = re.chg_degree";
query = query +  " 		and mx.dept_code = plan.dept_code";
query = query +  " 		and mx.dept_code = rec.dept_code";
query = query +  " 	";
query = query +  " order by tag_name, dept_code , sort_tag	";
%><%@ 
include file="../../../comm_function/conn_q_end.jsp"%>